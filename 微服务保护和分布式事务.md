# 服务保护

## 一、雪崩问题

**雪崩概念：**微服务调用链路中的某个服务发生故障，引起整个链路中的所有微服务都不可用，这就是雪崩。

**雪崩问题产生的原因是什么？**

- 微服务相互调用，服务提供者出现故障或阻塞。
- 服务调用者没有做好异常处理，导致自身故障。
- 调用链中的所有服务及联失败，导致整个集群故障。

**解决雪崩问题的思路**

- 尽量避免服务出现故障或阻塞。
  - 保证代码的健壮性
  - 保证网络的畅通
  - 能应对较高的并发请求
- 服务调用者做好远程调用异常的后备方案，避免故障扩散



## 二、服务保护方案

### 1.请求限流

**请求限流：**限制访问微服务的请求的并发量，避免服务因流量激增出现故障。



### 2. 线程隔离

**线程隔离：**也叫做**舱壁模式**，模拟船舱隔板的防水原理。通过限定每个业务能使用的线程数量而将故障业务隔离，避免**故障扩散**。



### 3. 服务熔断

**服务熔断：**由**断路器**统计请求的异常比例或慢调用比例，如果超出阈值则会**熔断**该业务，则拦截该接口的请求。熔断期间，所有请求快速失败，全都走falback逻辑（即备选方案）。

- 失败处理：定义fallback逻辑，让业务失败时不再抛出异常，而是返回默认数据或友好提示。



### 4. 服务保护技术 --- Sentinel

服务保护的技术比较常用的有：Sentinel和Hystrix，这里主要讲解Sentinel。

**Sentinel:**

- 线程隔离：信号量隔离
- 熔断策略：基于慢调用比例或异常比例
- 限流：基于QPS，支持流量整形
- Fallback：支持
- 控制台：开箱即用，可配置机制、查看秒级监控、机器发现等
- 配置方式：基于控制台，重启后失效



### 5. 初识Sentinel

**Sentinel**是阿里巴巴开源的一款微服务流量控制组件。具体操作可看官网地址：https://sentinelguard.io/zh-cn/

**簇点链路**

- 簇点链路就是单机调用链路。是一次请求进入服务后经过的每一个被Sentinel监控的资源链。默认Sentinel会监控SpringMVC的每一饿Endpoint(http接口)。限流、熔断等都是针对簇点链路中的**资源**设置的。而资源名默认就是接口的请求路径。



# 分布式事务

**分布式事务概念：**在分布式系统中，如果一个业务需要多个服务合作完成，而且**每一个服务**都有事务，多个事务必须同时成功或失败，这样的事务就是**分布式事务**。其中的每个服务的事务就是一个**分支事务**。整个业务成为称为**全局事务**。

## 1. 初识Seata

**Seata（Simple Extensible Autonomous Transaction Architecture）** 是一个开源的、阿里巴巴出品的 **分布式事务解决方案**，专门用来解决**微服务之间数据一致性问题**。

**分布式事务解决思路**：解决分布式事务，各个子事务之间必须能够感知到彼此的事务状态，才能保证状态一致。



## 2. Seata架构

**Seata事务管理中的三大核心角色：**

- **TC(Transaction Coordinator) - 事务协调者：**维护全局和分支事务的状态，协调全局事务提交或回滚。
- **TM(Transaction Manager) - 事务管理者：**定义全局事务的范围、开始全局事务、提交或回滚全局事务。
- **RM(Resource Manager) - 资源管理器：**管理分支事务，与TC交谈以注册分支事务和报告分支事务的状态。

![35882f01c23b50578e77fdde101c6a46](/Users/mac/Library/Containers/com.tencent.qq/Data/Library/Application Support/QQ/nt_qq_9b76092c973f79145ac7a67bca13c8ac/nt_data/Pic/2025-04/Ori/35882f01c23b50578e77fdde101c6a46.png)



## 3. XA模式

**XA规范**是X/Open组织定义的**分布式事务处理（DTP, Distributed Transaction Processing）标准**，XA规范描述了全局的TM与局部的RM之间的接口，几乎所有主流的关系型数据库都对XA规范提供了支持。Seata的XA模式如下：	

![e97d25668b29cd8497a0f75676eab07d_720](/Users/mac/Library/Containers/com.tencent.qq/Data/Library/Application Support/QQ/nt_qq_9b76092c973f79145ac7a67bca13c8ac/nt_data/Pic/2025-04/Thumb/e97d25668b29cd8497a0f75676eab07d_720.png)

- **一阶段的工作：**
  - RM注册分支事务到TC
  - RM执行分支业务sql但不提交
  - RM报告执行状态到TC
- **二阶段的工作：**
  - TC检测各分支事务执行状态：
  - a. 如果都成功，通知所有RM提交事务
  - b. 如果有失败，通知所有RM回滚事务
  - RM接收TC指令，提交或回滚事务
- **XA模式的优点：**
  - 事务的强一致性，满足ACID原则
  - 常用的数据库都支持，实现简单，并且没有代码侵入
- **XA模式的缺点：**
  - 因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差
  - 依赖关系型数据库实现事务



## 4. AT模式

**Seata主推的是AT模式，AT模式同样是分阶段提交的事务模型，不过弥补了XA模型中资源锁定周期过长的缺陷。**

![12828108eff3ddf2f25c54010c7e6048_720](/Users/mac/Library/Containers/com.tencent.qq/Data/Library/Application Support/QQ/nt_qq_9b76092c973f79145ac7a67bca13c8ac/nt_data/Pic/2025-04/Thumb/12828108eff3ddf2f25c54010c7e6048_720.png)

- **阶段一RM的工作：**
  - 注册分支事务
  - **记录undo-log（数据快照）**
  - 执行业务sql并提交
  - 报告事务状态
- **阶段二提交时RM的工作：**
  - 删除undo-log日志
- **阶段二回滚时RM的工作：**
  - 根据undo-log恢复数据到更新前

**AT模式与XA模式最大的区别**

- XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交，不锁定资源。
- XA模式依赖数据库机制实现回滚；AT模式利用数据快照实现数据回滚。
- XA模式强一致；AT模式最终一致。